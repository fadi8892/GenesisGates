<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ancestry Atlas 2 — GitHub Pages Build</title>
  <meta name="description" content="Family atlas demo with access code, map, AI OCR & face detection. GitHub Pages–friendly."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { borderRadius: { '2xl': '1rem' } } } }
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style> html, body { font-family: Inter, ui-sans-serif, system-ui, -apple-system; } </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <header class="max-w-6xl mx-auto p-6 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="h-8 w-8 rounded-2xl bg-gradient-to-br from-zinc-900 to-zinc-700 shadow-md"></div>
      <span class="font-semibold tracking-tight">Ancestry Atlas</span>
    </div>
    <nav class="text-sm text-zinc-600 hidden sm:flex gap-4">
      <a class="hover:underline" href="#" id="docsLink">Docs</a>
      <a class="hover:underline" href="#" id="privacyLink">Privacy</a>
    </nav>
  </header>

  <main id="landing" class="max-w-5xl mx-auto px-6 pt-4 pb-16">
    <div class="text-center">
      <h1 class="text-4xl md:text-6xl font-semibold tracking-tight leading-tight">
        Your family's story,<br class="hidden md:block"/> privately on the open web.
      </h1>
      <p class="mt-4 text-zinc-500 max-w-2xl mx-auto">
        Minimal, professional, and fast. Sign in. Drop an access code. Reveal a living family atlas with maps, photos, and history.
      </p>
    </div>

    <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-4">
      <section class="rounded-2xl bg-white border shadow-sm p-5">
        <div class="flex items-center gap-3 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 7h18v10H3z"/><path d="M16 7V5a2 2 0 0 0-2-2H7a4 4 0 0 0-4 4"/></svg>
          <div class="font-medium">Sign in with wallet</div>
        </div>
        <button id="btnWallet" class="rounded-2xl px-5 py-3 text-base bg-zinc-900 text-white w-full">Connect Wallet</button>
        <p class="text-xs text-zinc-500 mt-2">SIWE (ERC-4361) recommended. Works with MetaMask, Coinbase Wallet, etc.</p>
      </section>

      <section class="rounded-2xl bg-white border shadow-sm p-5">
        <div class="flex items-center gap-3 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 4h16v16H4z"/><path d="M22 6l-10 7L2 6"/></svg>
          <div class="font-medium">or email (embedded wallet)</div>
        </div>
        <div class="flex gap-2">
          <input id="email" type="email" placeholder="you@email.com" class="flex-1 rounded-xl border px-3 py-2"/>
          <button id="btnEmail" class="rounded-2xl px-5 py-3 text-base bg-zinc-900 text-white">Continue</button>
        </div>
        <p class="text-xs text-zinc-500 mt-2">Provision a self-custodial embedded wallet behind the scenes.</p>
      </section>

      <section class="rounded-2xl bg-white border shadow-sm p-5">
        <div class="flex items-center gap-3 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19 11V7a7 7 0 1 0-14 0v4"/><rect width="18" height="11" x="3" y="11" rx="2"/></svg>
          <div class="font-medium">Have an access code?</div>
        </div>
        <div class="flex gap-2">
          <input id="accessCode" placeholder="ABCDE-ABCDE-ABCDE-ABCDE-ABCDE" class="flex-1 rounded-xl border px-3 py-2 uppercase"/>
          <button id="btnOpenCode" class="rounded-2xl px-5 py-3 text-base bg-zinc-900 text-white">Open</button>
        </div>
        <p id="codeStatus" class="text-xs text-zinc-500 mt-2">Drop a code to view a specific family tree. Codes are long and unguessable.</p>
      </section>
    </div>
  </main>

  <section id="app" class="max-w-6xl mx-auto p-6 hidden">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-2xl bg-gradient-to-br from-zinc-900 to-zinc-700 shadow-md"></div>
        <div class="font-semibold">Ancestry Atlas</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnShowAccess" class="rounded-xl border px-3 py-2">Get Access Code</button>
        <button id="btnLogout" class="rounded-xl border px-3 py-2">Log out</button>
      </div>
    </div>

    <div class="grid grid-cols-4 gap-2">
      <button class="tab active rounded-2xl border px-3 py-2 bg-white" data-tab="overview">Overview</button>
      <button class="tab rounded-2xl border px-3 py-2 bg-white" data-tab="map">Map</button>
      <button class="tab rounded-2xl border px-3 py-2 bg-white" data-tab="ai">AI</button>
      <button class="tab rounded-2xl border px-3 py-2 bg-white" data-tab="privacy">Privacy</button>
    </div>

    <div id="panel-overview" class="mt-6">
      <div class="rounded-2xl bg-white border shadow-sm p-5">
        <div class="font-medium mb-4">Your Tree (minimal view)</div>
        <div id="peopleGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      </div>
    </div>

    <div id="panel-map" class="mt-6 hidden">
      <div class="rounded-2xl bg-white border shadow-sm p-5">
        <div class="font-medium mb-3">Family Map</div>
        <div id="map" class="w-full h-[520px] rounded-xl border"></div>
        <p class="text-xs text-zinc-500 mt-2">Lines show birthplace → current city per person. Circle size reflects relatives in a city.</p>
      </div>
    </div>

    <div id="panel-ai" class="mt-6 hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="rounded-2xl bg-white border shadow-sm p-5">
          <div class="font-medium">AI Photo Tagger (face detection)</div>
          <p class="text-xs text-zinc-500 mb-3">Detect faces locally. Models load on first use.</p>
          <div class="flex items-center gap-2 mb-2">
            <button id="btnLoadFace" class="rounded-xl border px-3 py-2">Load models</button>
            <span id="faceStatus" class="text-xs text-zinc-500">Models: not loaded</span>
          </div>
          <input id="faceFile" type="file" accept="image/*" class="mb-2"/>
          <div id="faceCanvas" class="rounded-xl border p-2 min-h-[140px] flex items-center justify-center text-xs text-zinc-500">Drop a portrait to detect faces…</div>
          <div class="text-xs text-zinc-500 mt-2">Detected faces: <span id="faceCount">0</span></div>
        </div>

        <div class="rounded-2xl bg-white border shadow-sm p-5">
          <div class="font-medium">AI Document Search (OCR demo)</div>
          <p class="text-xs text-zinc-500 mb-2">Drop a JPG/PNG scan — extract text in-browser.</p>
          <input id="ocrFile" type="file" accept="image/*" class="mb-2"/>
          <textarea id="ocrText" class="w-full h-40 text-sm border rounded-md p-2" placeholder="Extracted text will appear here…"></textarea>
        </div>
      </div>
    </div>

    <div id="panel-privacy" class="mt-6 hidden">
      <div class="rounded-2xl bg-white border shadow-sm p-5 text-sm text-zinc-700">
        <div class="font-medium mb-2">Privacy & Security</div>
        <ul class="list-disc pl-5 space-y-1">
          <li>Client‑side encryption for private fields.</li>
          <li>Decentralized DB for the tree; IPFS for media.</li>
          <li>Rotatable, signed access codes for viewing.</li>
        </ul>
      </div>
    </div>
  </section>

  <div id="accessModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-[90%] max-w-xl shadow-xl">
      <div class="font-medium mb-2">Share your tree securely</div>
      <p class="text-sm text-zinc-500">Anyone with the access code can view your tree. Rotate anytime.</p>
      <div class="rounded-xl border p-3 flex items-center justify-between mt-3">
        <code id="shareCode" class="text-lg font-mono">W7K3J-S9D2M-1HA9Z-QP8TU-3L0BN</code>
        <button id="btnCopyShare" class="rounded-xl border px-3 py-2">Copy</button>
      </div>
      <div class="text-right mt-4">
        <button id="btnCloseAccess" class="rounded-xl border px-3 py-2">Close</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
  <script>
  (function(){
    const PEOPLE = [
      { id: "p1", name: "Alex Pioneer", city: "San Diego, USA", lat: 32.7157, lon: -117.1611, born: "Baghdad, Iraq", blat: 33.3152, blon: 44.3661 },
      { id: "p2", name: "Brianna Pioneer", city: "Phoenix, USA", lat: 33.4484, lon: -112.0740, born: "Erbil, Iraq", blat: 36.1911, blon: 44.0092 },
      { id: "p3", name: "Casey Explorer", city: "Detroit, USA", lat: 42.3314, lon: -83.0458, born: "San Diego, USA", blat: 32.7157, blon: -117.1611 },
      { id: "p4", name: "Devon Explorer", city: "El Cajon, USA", lat: 32.7948, lon: -116.9625, born: "El Cajon, USA", blat: 32.7948, blon: -116.9625 }
    ];

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    function renderPeople() {
      const grid = qs('#peopleGrid');
      grid.innerHTML = '';
      PEOPLE.forEach(p => {
        const initials = p.name.split(' ').map(s => s[0]).slice(0,2).join('');
        const el = document.createElement('div');
        el.className = 'rounded-xl border p-3';
        el.innerHTML = '<div class="flex items-center gap-3">'
          + '<div class="h-10 w-10 rounded-full bg-zinc-100 flex items-center justify-center">'+initials+'</div>'
          + '<div><div class="font-medium leading-tight">'+p.name+'</div>'
          + '<div class="text-xs text-zinc-500">'+p.city+'</div></div></div>';
        grid.appendChild(el);
      });
    }

    function enterApp(){
      hide(qs('#landing'));
      show(qs('#app'));
      renderPeople();
    }

    function switchTab(name){
      ['overview','map','ai','privacy'].forEach(n => {
        qs('#panel-'+n).classList.toggle('hidden', n !== name);
        const btn = qs('.tab[data-tab="'+n+'"]');
        if (btn) btn.classList.toggle('active', n === name);
      });
      if (name === 'map' && !window._mapReady) initMap();
    }

    function isValidCode(str){
      return /^[A-Z2-7]{5}(-[A-Z2-7]{5}){4}$/.test((str||'').toUpperCase());
    }

    function openCode(){
      const code = qs('#accessCode').value.trim().toUpperCase();
      const status = qs('#codeStatus');
      if (!isValidCode(code)){
        status.textContent = 'Invalid code format';
        status.classList.remove('text-zinc-500'); status.classList.add('text-red-600');
        return;
      }
      status.textContent = 'Opening… (demo tree loaded)';
      status.classList.remove('text-red-600'); status.classList.add('text-zinc-500');
      enterApp();
    }

    function initMap(){
      window._mapReady = true;
      const map = L.map('map').setView([30, 10], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 6,
        attribution: '\u00A9 OpenStreetMap'
      }).addTo(map);

      const counts = new Map();
      PEOPLE.forEach(p => {
        if (!(Number.isFinite(p.lat) && Number.isFinite(p.lon))) return;
        const key = p.city + '|' + p.lat + '|' + p.lon;
        counts.set(key, (counts.get(key)||0) + 1);
      });
      counts.forEach((count, key) => {
        const [city, lat, lon] = key.split('|');
        const r = 6 + Math.min(10, count * 2);
        const circle = L.circleMarker([+lat, +lon], { radius: r, color: '#111827', fillColor:'#111827', fillOpacity: 0.7 });
        circle.bindTooltip(city + ' (' + count + ')');
        circle.addTo(map);
      });

      PEOPLE.forEach(p => {
        if (Number.isFinite(p.lat) && Number.isFinite(p.lon) && Number.isFinite(p.blat) && Number.isFinite(p.blon)) {
          const line = L.polyline([[p.blat, p.blon], [p.lat, p.lon]], { color: '#7c3aed', weight: 2, opacity: 0.8 });
          line.addTo(map);
        }
      });
    }

    async function runOCR(file){
      if (!file) return;
      const textarea = qs('#ocrText');
      textarea.value = 'Processing…';
      try{
        const { data } = await Tesseract.recognize(file, 'eng');
        textarea.value = data.text || '';
      }catch(e){
        textarea.value = 'OCR failed. Try a clearer image.';
      }
    }

    let faceModelsLoaded = false;
    async function loadFaceModels(){
      const status = qs('#faceStatus');
      status.textContent = 'Loading models…';
      try{
        await import('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js');
        const base = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
        await window.faceapi.nets.ssdMobilenetv1.loadFromUri(base);
        await window.faceapi.nets.faceLandmark68Net.loadFromUri(base);
        await window.faceapi.nets.faceRecognitionNet.loadFromUri(base);
        faceModelsLoaded = true;
        status.textContent = 'Models ready';
      }catch(e){
        status.textContent = 'Failed to load models';
      }
    }
    async function runFaceDetect(file){
      if (!file){ return; }
      if (!faceModelsLoaded){ alert('Click "Load models" first'); return; }
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = async () => {
        const canvas = qs('#faceCanvas');
        canvas.innerHTML = '';
        canvas.appendChild(img);
        try{
          const detections = await window.faceapi.detectAllFaces(img).withFaceLandmarks().withFaceDescriptors();
          qs('#faceCount').textContent = (detections && detections.length) ? detections.length : 0;
        }catch(e){ qs('#faceCount').textContent = '0'; }
      };
      img.src = url;
    }

    document.addEventListener('DOMContentLoaded', () => {
      qs('#docsLink').addEventListener('click', e => { e.preventDefault(); alert('Docs coming soon'); });
      qs('#privacyLink').addEventListener('click', e => { e.preventDefault(); alert('Privacy: encrypt private fields with Lit Protocol'); });

      qs('#btnWallet').addEventListener('click', enterApp);
      qs('#btnEmail').addEventListener('click', () => {
        const email = qs('#email').value.trim();
        if (!email) { alert('Enter an email'); return; }
        enterApp();
      });
      qs('#btnOpenCode').addEventListener('click', openCode);

      qs('#btnLogout').addEventListener('click', () => { hide(qs('#app')); show(qs('#landing')); });
      qs('#btnShowAccess').addEventListener('click', () => { const m = qs('#accessModal'); m.classList.remove('hidden'); m.classList.add('flex'); });
      qs('#btnCloseAccess').addEventListener('click', () => { const m = qs('#accessModal'); m.classList.add('hidden'); m.classList.remove('flex'); });
      qs('#btnCopyShare').addEventListener('click', async () => { await navigator.clipboard.writeText(qs('#shareCode').textContent); alert('Access code copied'); });

      qsa('.tab').forEach(btn => btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab'))));

      qs('#ocrFile').addEventListener('change', e => runOCR(e.target.files && e.target.files[0]));
      qs('#btnLoadFace').addEventListener('click', loadFaceModels);
      qs('#faceFile').addEventListener('change', e => runFaceDetect(e.target.files && e.target.files[0]));
    });
  })();
  </script>
</body>
</html>
